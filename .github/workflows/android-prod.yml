name: Deploy Android App to Play Store

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  repository_dispatch:
    types: ['deploy-android-to-play-store']

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [12.x]

    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2

    # https://help.github.com/en/actions/reference/workflow-commands-for-github-actions#setting-an-environment-variable
    - name: Set environment variables that would be available between all jobs
      run: |
        echo "::set-env name=SSH_AUTH_SOCK::/tmp/ssh_agent.sock"
        echo "::set-env name=USER_NAME::${{ secrets.GITLAB_USER_NAME }}"
        echo "::set-env name=USER_EMAIL::${{ secrets.GITLAB_USER_EMAIL }}"
        echo "::set-env name=SSH_KNOWN_HOST::${{ secrets.SSH_KNOWN_HOST }}"
        echo "::set-env name=SSH_PRIVATE_KEY::${{ secrets.SSH_PRIVATE_KEY }}"
        echo "::set-env name=CURRENT_BRANCH::${{ github.event.client_payload.branch }}"
        echo "::set-env name=REPO_URL::${{ secrets.REPO_URL }}"
        echo "::set-env name=ENCRYPT_PASSWORD::${{ secrets.ENCRYPT_PASSWORD }}"
        echo "::set-env name=DATABASE_DEFAULT_ENCRYPTION_KEY::${{ secrets.DATABASE_DEFAULT_ENCRYPTION_KEY }}"
        echo "::set-env name=OAUTH_CLIENT_ID_ANDROID::${{ secrets.OAUTH_CLIENT_ID_ANDROID }}"
        echo "::set-env name=APP_METRICA_API_KEY::${{ secrets.APP_METRICA_API_KEY }}"
        echo "::set-env name=APP_METRICA_API_KEY::${{ github.event.client_payload.bump_type }}

    - name: Check all required variables
      run: sh ./scripts/common-check.sh && sh ./scripts/android-prod-check.sh

    - name: Configure git users
      run: |
          git config --global user.name "$USER_NAME"
          git config --global user.email "$USER_EMAIL"

    - name: Setup SSH keys and known_hosts
      run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan $SSH_KNOWN_HOST >> ~/.ssh/known_hosts
          ssh-agent -a $SSH_AUTH_SOCK > /dev/null
          ssh-add - <<< "$SSH_PRIVATE_KEY"
    
    - name: Get repository
      run: |
        rm -rf ./.git ./.github ./*
        ls -la ./
        git clone "$REPO_URL" --branch="$CURRENT_BRANCH" --single --depth=1 ./
        git log -1

    - name: Install Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}
    - uses: actions/setup-ruby@v1
      with:
        ruby-version: '2.x'

    - name: Install Fastlane
      run: bundle install

    - name: Install packages
      run: |
        yarn --version
        yarn install --frozen-lockfile
    
    - name: Decrypt keystore and Google Credentials
      run: sh ../scripts/android-gpg-decrypt.sh

    - name: Run fastlane line "fastlane android deploy" with PROD ENV variables
      run: bundle exec fastlane android deploy

name: Deploy iOS App to Test Flight

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  repository_dispatch:
    types: ['deploy-ios-to-test-flight']

jobs:
  deploy_to_app_distribution:
    runs-on: macos-latest

    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2

    # https://help.github.com/en/actions/reference/workflow-commands-for-github-actions#setting-an-environment-variable
    - name: Set environment variables that would be available between all jobs
      run: |
        echo "::set-env name=SSH_AUTH_SOCK::/tmp/ssh_agent.sock"
        echo "::set-env name=USER_NAME::${{ secrets.GITLAB_USER_NAME }}"
        echo "::set-env name=USER_EMAIL::${{ secrets.GITLAB_USER_EMAIL }}"
        echo "::set-env name=SSH_KNOWN_HOST::${{ secrets.SSH_KNOWN_HOST }}"
        echo "::set-env name=SSH_PRIVATE_KEY::${{ secrets.SSH_PRIVATE_KEY }}"
        echo "::set-env name=CURRENT_BRANCH::${{ github.event.client_payload.branch }}"
        echo "::set-env name=REPO_URL::${{ secrets.REPO_URL }}"
        echo "::set-env name=DATABASE_DEFAULT_ENCRYPTION_KEY::${{ secrets.DATABASE_DEFAULT_ENCRYPTION_KEY }}"
        echo "::set-env name=OAUTH_CLIENT_ID_ANDROID::${{ secrets.OAUTH_CLIENT_ID_ANDROID }}"
        echo "::set-env name=APP_METRICA_API_KEY::${{ secrets.APP_METRICA_API_KEY }}"
        echo "::set-env name=FASTLANE_USER::${{ secrets.FASTLANE_USER }}"
        echo "::set-env name=FASTLANE_PASSWORD::${{ secrets.FASTLANE_PASSWORD }}"
        echo "::set-env name=FASTLANE_SESSION::${{ secrets.FASTLANE_SESSION }}"
        echo "::set-env name=MATCH_GIT_BASIC_AUTHORIZATION::${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}"
        echo "::set-env name=MATCH_PASSWORD::${{ secrets.MATCH_PASSWORD }}"
        echo "::set-env name=FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD::${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}"
        echo "::set-env name=BUMP_TYPE::${{ github.event.client_payload.bump_type }}

    - name: Check all required variables
      run: sh ./scripts/common-check.sh && sh ./scripts/ios-prod-check.sh

    - name: Configure git users
      run: |
          git config --global user.name "$USER_NAME"
          git config --global user.email "$USER_EMAIL"

    - name: Setup SSH keys and known_hosts
      run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan $SSH_KNOWN_HOST >> ~/.ssh/known_hosts
          ssh-agent -a $SSH_AUTH_SOCK > /dev/null
          ssh-add ~/.ssh/id_rsa

    - name: Get repository
      run: |
        rm -rf ./.git ./.github ./*
        ls -la ./
        git clone "$REPO_URL" --branch="$CURRENT_BRANCH" --single --depth=1 ./
        git log -1


    - name: Install Node.js 12.x
      uses: actions/setup-node@v1
      with:
        node-version: 12.x

    - name: Install Ruby 2.x
      uses: actions/setup-ruby@v1
      with:
        ruby-version: '2.x'

    - name: Install packages
      run: yarn install --frozen-lockfile --cache-folder /tmp/cache/yarn

    - name: Install pods
      run: pod install
      working-directory: ios

    - name: Install gem dependencies
      run: |
        bundle config path vendor/bundle
        bundle install --jobs 4 --retry 3

    - name: Run fastlane line "fastlane ios deploy" with PROD ENV variables
      run: bundle exec fastlane ios deploy
